% !TEX encoding = UTF-8 Unicode
\documentclass[a4paper]{article}
%\usepackage[T1]{fontenc}     % För svenska bokstäver
\usepackage[utf8]{inputenc}  % Teckenkodning UTF8
%\usepackage[swedish]{babel}  % För svensk avstavning och svenska
                             % rubriker (t ex Innehållsförteckning)
\usepackage{fancyvrb}        % För programlistor med tabulatorer
\fvset{tabsize=4}            % Tabulatorpositioner
\fvset{fontsize=\small}      % Lagom storlek för programlistor
\usepackage[labelfont=bf]{caption}
\usepackage{hyperref}
\usepackage{graphicx}         % För att inkludera bilder.
\usepackage{float}

\title{Lego Mindstorm Project: Lego Segway\\
Course FRTN01 - Real time systems}
\author{Simon Wallström, dat11swa@student.lu.se\\
Adam Dalentoft, dat11ada@student.lu.se\\
Jonathan Karlsson, ada09jka@student.lu.se}
%\date{1 augusti 1994}        % Blir dagens datum om det utelämnas
\begin{document}              % Början på dokumentet

\maketitle
\thispagestyle{empty}
\newpage
\setcounter{page}{1}
\tableofcontents
\newpage
\section{Introduction}
The goal of this project is to build and control a two-wheeled robot - a Lego Segway - using NXT Lego Mindstorm 2.0. A segway is an unstable system that constantly needs to be regulated to work. To regulate this system several parameters is required. It is important to know the mass and specifications of the hardware that is used and the physics and movements in the system. Basically how it works is that the the robot tilts and the angle is measured. Thereafter the angle is processed by the controller to calculate the required change in degree for the wheels. It is possible to control the segway in a few different ways. One way is to use pole placing and feedback control. Even though this is a good way to regulate the system it is hard to realize. Therefore the structure that will be described in this report uses two PID controllers, one for the wheel position and one for the angle of the robot.\\

\begin{figure}[H]
  \centering
\includegraphics[scale=0.8]{pic/segway.png}
\caption{el caprioneE}
\end{figure}

Before the implementation can begin it is a good idea to set up a model of the process. The process is described in the picture, including the different variables that is needed to calculate the movements in the system. These variables are the used to calculate the state-space form for the system, describing the equation L = T - V. The state-space form of the system can thereafter be used in matlab and simulink to describe a control system for the segway. Simulink can also be used to make a simulation of the calculated system to determine parameters for the PID-controllers. \\

To implement the controller a Java version for Lego NXT is used called LeJOS. There are several alternatives in other languages but this is the only widely known Java VM. LeJOS provides classes for the most common hardware to the Lego NXT.  \\

To measure the angles a gyroscope and an accelerometer are used. The gyroscope measure the angle velocity and the integrated value gives the angle of the tilted segway. However the gyroscopes raw value drifts and therefore the accelerometer is required to compensate for this. Rest of the hardware is standard nxt motors and base unit.



\section{Program structure}
The program uses threads to realize a real time controlled system. The LeJOS VM provides support for real time threads and synchronization, the same as standard Java. There is a variety of classes building up the program, these are described in the diagram below. To clarify the meaning of the different classes there is also a brief description of them.\\

\begin{figure}[H]
  \centering
\includegraphics[scale=0.5]{pic/UML_LEGO_SEGWAY_ALLCAPS.png}
\caption{el caprioneE}
\end{figure}

\begin{itemize}
\item StartUp: main class, starts all the other classes and threads.
\item OpCom: Operator communication class, handles user input through the buttons on the base unit. Some of the commands are mode change and program exit. 
\item RefGen: Reference generator. Generate reference values for input to the robot. 
\item RegulAndIO: Control class and hardware communicator. Uses the PIDController class together with the hardware input and output to run and balance the segway.
\item PIDController: Controller class. Calculate the P, I and D values using a standard control equation.
Hardware: All the hardware connected to the software together with their in and output methods.
\end{itemize}

\section{Control design}
As mentioned in the introduction the controller will contain two PID-controllers. They are connected in a cascade to regulate the two angles: tilt angle and wheel angle (rotation of the wheel). The inner loop controls the tilt angle by moving the wheels and the outer loop controls the wheel position in case of a reference change.\\

BILD\\

The main reason for this choice of control structure is the rather easy way to implement it. As mentioned in the introduction there are other ways to control the system, but this method has been used earlier in the course which made it more natural to implement. \\

The figure describes how the control structure works. First the reference value is sent in. It can either be 0, to stand still, or a value decided by the reference generator. The mode is decided by the user (further description in the user information section). This value describes the desired position of the segway. Thereafter the value, together with the feedback values from the previous calculations, is processed by the two PID-controllers. When the segway should stand still only the inner loop is required. \\

A optional solution is to use state feedback. Here the different measurements (angle, position, angular velocity and wheel movement) of the system is fed back and thereby the different states of the system is regulated based on previous location and value.

\section{User information}

The segway do not have a user interface except the small screen and the buttons on the front of the base unit. When the segway is in motion these become a rather impractical way of controlling the system. Therefore the system is started before it is put down. It is however possible to change mode with the buttons from stand still mode and a mode that changes the reference value to make the robot move forward and backward. A press on the dark grey button, the Escape button, will quit the program. The screen give out small messages to inform the user how to handle the robot and what is happening in the system.\\

The program should be pre-installed on the machine. To run it is done in a few simple steps. 

\begin{enumerate}
\item First start the segway using the large yellow button, the Enter button.
\item On the screen a menu will be displayed. Choose the default program on the screen.
\item Now the program starts. A message will be displayed, “Calibrating...”. It is important to hold the robot stationary, otherwise the calibration of the hardware may be disturbed.
\item After the calibration, the message "Calibrated, hold robot and press Enter to balance" is shown. Now, put down the robot on the ground and press the Enter key.
\item After the massage “Balancing” is displayed the segway will start to balance, hopefully. 
\item If a different mode than the default one is selected the balancing point may differ and the segway will move forward and backward.
\item To terminate the program push the Escape key.
\end{enumerate}

\section{Results}
Inget funkar. plots n stuff\\

\begin{figure}[H]
  \centering
\includegraphics[scale=0.456]{pic/GyroAccCombAng.png}
\caption{el caprioneE}
\end{figure}

\section{Conclution}
The project in itself is a good example of real-time-programming and control. To complete the project it is required to have knowledge in both of the areas. Even though implementing a segway is a common control task (both as a Lego mindstorms project and other) is it not an easy task. \\

As all for realizations of theory there are error sources, this is no exception. To start with, the hardware is not perfect. As previously mentioned the gyroscope drifts, that is because of temperature shifts. This is solved by using a low pass filter together with an accelerometer to smoothe out the measurements and thereby eliminate the offset. Even though the gyroscope problem is solved the accelerometer introduce another one by having a long measurement time. Thereby the period has to be increased which makes the whole system slower and more unstable. The rest of the hardware can also give errors, such as the motors being unsynchronized, cable problems and computing errors in the base unit.\\

The software implementation can also give some errors, especially the parameters of the PID controller. Tuning the parameters is extremely time consuming and even the smallest change can give a large difference.

\section{Own reflections}
The project has been fun to work with, but also very time consuming and challenging. At the first stages of the project the model was constructed. This model was helpful when it came to understanding and setting up the basics for the whole project. Simulink is a good tool to build up a control system and to give a view over how the solution could be implemented. From the model, an equation for the PID controllers was calculated. It was not easy to understand how the controller should be implemented to fit both the model and the Java implementation, but in the end a solution given by the course laborations and lectures was used.The java code for the segway was then written and the equation was used in the first stages of the parameter tuning. The implementation had different stages where different combinations of threads and monitors were used. The most time consuming part of the project was tuning the PID parameters. During this time a decision to change the control design to a state-space feedback was made, because the segway had problems stabilising. This new method was rather new and unexplored because all the preparations and simulations were made matching the first solution.

\end{document}                  % Slut på dokumentet



%\begin{figure}[H]
%  \centering
%\includegraphics[scale=0.8]{xXx.png}
%\caption{el caprioneE}
%\end{figure}